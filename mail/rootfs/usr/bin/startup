#!/bin/bash


### Check variable
[[ -z $DOMAIN ]] && echo "DOMAIN is empty" && exit 1
[[ -z $FQDN ]] && echo "FQDN is empty" && exit 1

### Create Folder
mkdir -p /mail/vhosts/$DOMAIN
groupadd -g $GID vmail
useradd -g vmail -u $UID vmail -d /mail

### Apply permission
chown -R vmail:dovecot /etc/dovecot
chmod -R o-rwx /etc/dovecot
chown -R vmail:vmail /mail
chmod 1777 /tmp

### Create and Configure mysql if localhost
if [ "$db_host" == "localhost" ] || [ "$db_host" == "127.0.0.1" ] || [ -z $db_host ]
then
	db_host="localhost"
	echo "Install mysqld ..."
	export DEBIAN_FRONTEND=noninteractive && apt-get update && apt-get -y install mysql-server pwgen

	if [ -z ${mysql_root_password} ]
	then
		mysql_root_password=$(pwgen -1 32)
		echo "Generated random root password : ${mysql_root_password}"
	fi
	mysqld --initialize-insecure=on --datadir=/var/lib/mysql
	sleep 2
	mysqld --skip-networking &
	sleep 2
	mysql -uroot --protocol=socket <<-EOF
		DELETE FROM mysql.user;
		CREATE USER 'root'@'%' IDENTIFIED BY '${mysql_root_password}';
		GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION;
		DROP DATABASE IF EXISTS test;
		FLUSH PRIVILEGES;
	EOF

	[[ -z $db_name ]] && db_name="postfix"
	[[ -z $db_user ]] && db_user="postfix"
	[[ -z $db_passwd ]] && db_passwd=$(pwgen -1 32) && echo "Generated random ${db_user} password for ${db_name} : ${db_passwd}"

	echo "Create postfix database scheme ..."
	mysql -uroot -hlocalhost -p$mysql_root_password <<-EOF
		CREATE DATABASE ${db_name};
		CREATE USER '${db_user}'@'localhost' IDENTIFIED BY '${db_passwd}';
		GRANT ALL ON ${db_name}.* TO '${db_user}'@'localhost' WITH GRANT OPTION;
		USE ${db_name};
		SOURCE /tmp/scheme.sql;
	EOF

	

	kill -9 $(ps aux | grep mysqld | grep -v grep | awk '{print $2}')
else
	if [ -z $db_name ] || [ -z $db_user ] || [ -z $db_passwd ]
	then
		echo "Error : db connection failed"
		exit 1
	fi
fi

### Generate SSL if not exist
echo "Generate SSL certificate"
mkdir -p /ssl/selfsigned/
[[ -z $postfix_cafile ]] && postfix_cafile=/ssl/selfsigned/ca.cert.pem 
[[ -z $postfix_certfile ]] && postfix_certfile=/ssl/selfsigned/mailserver.crt
[[ -z $postfix_keyfile ]] && postfix_keyfile=/ssl/selfsigned/mailserver.key
[[ -z $dovecot_certfile ]] && dovecot_certfile=/ssl/selfsigned/mailserver.crt
[[ -z $dovecot_keyfile ]] && dovecot_keyfile=/ssl/selfsigned/mailserver.key

if [ ! -e $postfix_cafile ]
then
	openssl genrsa -out /ssl/selfsigned/ca.key.pem 4096
	openssl req $@ -new -x509 -nodes -days 3650 -sha512 -subj "/C=US/ST=Californie/L=Springfield/O=MyMailServer/CN=RootCA" -key /ssl/selfsigned/ca.key.pem -out $postfix_cafile
fi
if [ ! -e $postfix_certfile ] || [ ! -e $postfix_keyfile ]
then
	openssl genrsa -out $postfix_keyfile 4096
	openssl req $@ -new -sha512 -subj "/C=US/ST=Californie/L=Springfield/O=MyMailServer/CN=${FQDN}" -key $postfix_keyfile -out /ssl/selfsigned/mailserver.csr
	openssl x509 -req -days 3650 -sha512 -in /ssl/selfsigned/mailserver.csr -CA $postfix_cafile -CAkey /ssl/selfsigned/ca.key.pem -CAcreateserial -out $postfix_certfile
fi

### Check Configuration
sed -i 's/<FQDN>/'$FQDN'/g' /etc/postfix/main.cf
sed -i 's/<DOMAIN>/'$DOMAIN'/g' /etc/postfix/main.cf
sed -i 's/<UID>/'$UID'/g' /etc/postfix/main.cf
sed -i 's/<GID>/'$GID'/g' /etc/postfix/main.cf
sed -i 's/<db_host>/'$db_host'/g' /etc/postfix/*.cf
sed -i 's/<db_name>/'$db_name'/g' /etc/postfix/*.cf
sed -i 's/<db_user>/'$db_user'/g' /etc/postfix/*.cf
sed -i 's/<db_passwd>/'$db_passwd'/g' /etc/postfix/*.cf
sed -i 's|<postfix_cafile>|'$postfix_cafile'|g' /etc/postfix/main.cf
sed -i 's|<postfix_certfile>|'$postfix_certfile'|g' /etc/postfix/main.cf
sed -i 's|<postfix_keyfile>|'$postfix_keyfile'|g' /etc/postfix/main.cf

sed -i 's/<UID>/'$UID'/g' /etc/dovecot/conf.d/*.conf
sed -i 's/<GID>/'$GID'/g' /etc/dovecot/conf.d/*.conf
sed -i 's/<db_host>/'$db_host'/g' /etc/dovecot/conf.d/*.ext
sed -i 's/<db_name>/'$db_name'/g' /etc/dovecot/conf.d/*.ext
sed -i 's/<db_user>/'$db_user'/g' /etc/dovecot/conf.d/*.ext
sed -i 's/<db_passwd>/'$db_passwd'/g' /etc/dovecot/conf.d/*.ext
sed -i 's|<dovecot_certfile>|'$dovecot_certfile'|g' /etc/dovecot/conf.d/10-ssl.conf
sed -i 's|<dovecot_keyfile>|'$dovecot_keyfile'|g' /etc/dovecot/conf.d/10-ssl.conf


### Launch Supervisord
mysqld &
